stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  API_IMAGE: $CI_REGISTRY_IMAGE/api
  WEB_IMAGE: $CI_REGISTRY_IMAGE/web

# Use Docker-in-Docker for building images
.docker_build_template:
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# Build .NET API Docker image
build:api:
  extends: .docker_build_template
  stage: build
  script:
    - cd apps/api
    - docker build -t $API_IMAGE:$CI_COMMIT_SHORT_SHA -t $API_IMAGE:latest -f Dockerfile ../..
    - docker push $API_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $API_IMAGE:latest
  only:
    changes:
      - apps/api/**/*
      - apps/domain/**/*
      - VeTool.sln
      - .gitlab-ci.yml
  tags:
    - docker

# Build Next.js web Docker image
build:web:
  extends: .docker_build_template
  stage: build
  script:
    - cd apps/web
    - docker build -t $WEB_IMAGE:$CI_COMMIT_SHORT_SHA -t $WEB_IMAGE:latest -f Dockerfile .
    - docker push $WEB_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $WEB_IMAGE:latest
  only:
    changes:
      - apps/web/**/*
      - .gitlab-ci.yml
  tags:
    - docker

# Run .NET tests
test:api:
  image: mcr.microsoft.com/dotnet/sdk:8.0
  stage: test
  script:
    - dotnet restore
    - dotnet build --no-restore
    - dotnet test --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
  artifacts:
    when: always
    reports:
      junit:
        - "**/test-results.trx"
    paths:
      - "**/test-results.trx"
    expire_in: 30 days
  tags:
    - docker

# Deploy to staging environment
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $STAGING_USER@$STAGING_SERVER << 'EOF'
        cd /var/www/vetool
        docker-compose pull
        docker-compose up -d --remove-orphans
        docker-compose exec -T api dotnet ef database update
        docker system prune -f
      EOF
  environment:
    name: staging
    url: https://staging.vetool.example.com
  only:
    - develop
  tags:
    - deploy

# Deploy to production environment
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_SERVER << 'EOF'
        cd /var/www/vetool
        docker-compose pull
        docker-compose up -d --remove-orphans
        docker-compose exec -T api dotnet ef database update
        docker system prune -f
      EOF
  environment:
    name: production
    url: https://vetool.example.com
  only:
    - main
  when: manual
  tags:
    - deploy

# Cleanup old images
cleanup:
  stage: deploy
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker system prune -af --volumes
  only:
    - schedules
  tags:
    - docker
